{% extends "base.html" %}

{% block title %}Code Report{% endblock %}

{% block content %}
    <section id="global-recap">
        <h1>üìù Code Report</h1>
        <div class="card">
            <div class="d-flex d-justify-between">
                <span class="badge {{ 'badge-error' if global_summary.total > 0 else 'badge-success' }}">
                    <strong>{{ global_summary.total }}</strong> vulnerabilities
                </span>
                <div class="severity-dots">
                    {% for level in severity_order %}
                    <span class="severity-dot">
                        <span class="dot dot-{{ level }}"></span>
                        <span>
                            <strong>{{ global_summary[level] }}</strong>
                            {{ level.capitalize() }}
                        </span>
                    </span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>

    <div id="repos">
        {% for repo_name, repo_data in data.items() %}
            <div class="card project-card">
               <div class="project-header">
                    <h3>{{ repo_name }}</h3>
                    <a href="{{ repo_data.url }}" target="_blank">
                        <img id="logo" src="data:image/svg+xml;base64,{{ git_icon_b64 }}" alt="Git Repository">
                    </a>
                </div>
                <p class="project-description">{{ repo_data.description }}</p>

                {% if repo_data.error %}
                    <p class="error">‚ùå Scan failed: {{ repo_data.error }}</p>
                {% else %}
                    <div class="d-flex d-justify-between mb-20">
                        <span class="badge {{ 'badge-error' if repo_data.findings_count > 0 else 'badge-success' }}">
                            <strong>{{ repo_data.findings_count }}</strong> {{ repo_data.findings_count | pluralize('vulnerability') }}</span>
                        </span>
                        <div class="severity-dots">
                            {% for level in severity_order %}
                            <span class="severity-dot">
                                <span class="dot dot-{{ level }}"></span>
                                <span>
                                    <strong>{{ repo_data.findings_by_severity.get(level, 0) }}</strong>
                                    {{ level.capitalize() }}
                                </span>
                            </span>
                            {% endfor %}
                        </div>
                    </div>

                    <p><strong>üïµÔ∏è Findings Details:</strong></p>
                    <div class="packages-list">
                        {% if repo_data.findings %}
                            {% for finding in repo_data.findings %}
                            <div class="{{ finding.severity }}">
                                <strong>{{ finding.rule_id or "Unknown Rule" }}</strong> ‚Äî
                                {{ finding.message }}
                                <br>
                                <small>
                                    File: {{ finding.location.file or "N/A" }}:{{ finding.location.line or "?" }},
                                    Severity: {{ finding.severity | capitalize }}
                                </small>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="no-issues success mb-0">None - All clear!</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>

{% endblock %}
