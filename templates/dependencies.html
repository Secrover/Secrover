{% extends "base.html" %}

{% block title %}Dependencies Report{% endblock %}

{% block content %}
    <section id="global-recap">
        <h1>ðŸ“¦ Dependencies Report</h1>
        <div class="card">
            <div class="d-flex d-justify-between">
                <span class="badge {{ 'badge-error' if global_summary.total > 0 else 'badge-success' }}">
                    <strong>{{ global_summary.total }}</strong> {{ global_summary.total | pluralize('vulnerability') }}
                </span>
                <div class="severity-dots">
                    {% for level in severity_order %}
                    <span class="severity-dot">
                        <span class="dot dot-{{ level }}"></span>
                        <span>
                            <strong>{{ global_summary[level] }}</strong>
                            {{ level.capitalize() }}
                        </span>
                    </span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>

    <div id="repos">
        {% for repo_name, repo_data in data.items() %}
            {% set audit = repo_data.audit %}
            {% if not audit %}
                <div class="card project-card">
                    <div class="project-header">
                        <h3>{{ repo_name }}</h3>
                    </div>
                    <p class="project-description">{{ repo_data.description }}</p>
                    <p class="mb-0">No audit data available.</p>
                </div>
            {% else %}
                <div class="card project-card">
                    <div class="project-header">
                        <h3>{{ repo_name }}</h3>
                    </div>
                    <p class="project-description">{{ repo_data.description }}</p>

                    <div class="d-flex d-justify-between mb-20">
                        <span class="badge {{ 'badge-error' if audit.total_vulnerabilities > 0 else 'badge-success' }}">
                            <strong>{{ audit.total_vulnerabilities }}</strong> {{ audit.total_vulnerabilities | pluralize('vulnerability') }}</span>
                        </span>
                        <div class="severity-dots">
                            {% for level in severity_order %}
                            <span class="severity-dot">
                                <span class="dot dot-{{ level }}"></span>
                                <span>
                                    <strong>{{ audit.vulnerabilities_by_severity.get(level, 0) }}</strong>
                                    {{ level.capitalize() }}
                                </span>
                            </span>
                            {% endfor %}
                        </div>
                    </div>

                    <p><strong>ðŸ“¦ Impacted Packages:</strong></p>
                    {% if audit.packages_impacted %}
                        {% for file, pkgs in audit.packages_by_file.items() %}
                            <h4>{{ file }}</h4>
                            <div class="packages-list">
                                {% for pkg in pkgs %}
                                    <div class="{{ pkg.severity }}">
                                        {{ pkg.name }} <span>{{ pkg.version }}</span>
                                        {% if pkg.cves %}
                                            <small>
                                                <a href="{{ pkg.url }}" target="_blank">{{ pkg.cves | join(', ') }}</a>
                                            </small>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="packages-list">
                            <p class="no-issues success mb-0">None - All clear!</p>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    </div>

{% endblock %}
